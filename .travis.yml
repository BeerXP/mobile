install:
  - bundle install
  - brew install watchman
  - npm install
  - npm ci
matrix:
  include:
  - os: osx
      language: swift
      osx_image: xcode10
      xcode_project: ios/BeerXP.xcodeproj # path to your xcodeproj folder
      xcode_scheme: BeerXP
      before_install:
        - brew install jq
      # script:
      # - bundle exec fastlane ios tests
  - os: osx 
    language: android
    sudo: required
    dist: precise
    jdk: oraclejdk8

    before_cache:
      - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
      - rm -rf $HOME/.gradle/caches/*/plugin-resolution/

    cache:
      yarn: true
      directories:
        - $HOME/.yarn-cache
        - $HOME/.gradle/caches/
        - $HOME/.gradle/wrapper/
        - $HOME/.android/build-cache
        - node_modules

    install:
      - yarn install

    env:
      global:
      - ANDROID_API=28
      - ANDROID_BUILD_TOOLS=28.0.3
      - ADB_INSTALL_TIMEOUT=5 # Minutes.
      - secure: "HFQl8xoFyrfOMV/Ewe16mIROvB9BmC5Y7sCnR6ZNk86F1AEzzTXMuXpCFL9bJ4W+spez70ab+2wiAwCbpP01RQYLvEC0gIa7EhOQlg0eSZS1TVZEB4vASOV6eBc/FXoiYEjOV2rc8ycP48BOl8XCeK7HkesVH+O5HEui0nYvLaMJNol+9RHVlOBwk7S/AqcJC1J0dIWNDPV6g7dzAqyvqDuh7UNbbLjS04e8qiu3ezky78SZAD3VxkwxZLPcQ04Ehxkp3UC63i84T1cCeHHPkzpmEJLy1SnRzQ4OQLPlHZw8KkPiK6g6VWBJk+Oqh8mmcdwirVzExpVMcP8xJRcKMWqWjsK0rLM1g+gyW4tZg+g+y6FRqfOEXxMlcrBXTHaMM1gGeLwIwyHjhVM4yF4pCttsJUnIQ4x1xEI3qpie/QTmyAui486LWJxfXGyyUACZGgt4s2OpcX2E1Eqf0tJdSf6vWJkf2A9AgjaWSlfCmzmH1uGSSNdVhp+HAru1gX57eOXYcAuIPtaSPS1YSbNADEv1sgxzl889pEmzO1wqaVcthw+c1nSNiEt3/HlkuJ9rs01kX8/hzNwQnsO9Ka1y92xWS8+5YB/KH/y5LEZQc30MYbMFQtt20A90c+GjNeZKfqgxy0hh2rvNqnfG5eu3fkui1uyZrkdr9vOBVkjeSoA=" # storepass
      - secure: "D5rdnl0o5yrwHrejFDz9ulOj/kJNiO9egDBTudeFd6bb++XWeU7ForE3mzldn6qzCX4Gz+gHDVuySPzKuvw1Oe2hfAX61vsqWyFFoxZci6M2TR84Fuy4H1KIYxfaUyk79NmvlvPvgc9+MKV02k9v86DxisjCz/vz3Usmp2tlVEo1s4gbwLyCM4XEYP0slOrKYW2quEIu106vTwAzmWVkwMnoShOevJVIIMe/ThQw4oSlQyxTvCR77xSWTu6VKeVcuH2VWP78jBoQbpgxoFliLcTco7iPK3+1xsJUsZgoRK+l/0H0Q2hli30Pw9FJDPTnuTpBjfPI1tPIIyh4kx59krZn4+bkGJuI67jl7nC4IxK/ygWM7wKV38ntvA4ZdoHxLy9VhKQu3RoCe6Erp6/LDVqNA6lDr6EhooTGFE62bzVXbRmh3e4j6f08MaY9e8uWxyEOk7jmrj8m1og/izcr6bs/sDST95TVoKDpkPODxwEEuVTS2aN3Glu/C85EInOB7xIP9re6rFbtTjyj6Zyytjt5izRPU8JnFArdGwLSAp9JB8wjfhYm5rNyS63zngXtm8RruCHWPBtPWNYlMFXozIs1D0mPqtM/hth03l0fD350UI3RPCFQhXLp2x9vCW+yHG4qAECgk5px2nmnMspOno7n2KU6MOHYQZRzORUYryk=" # keypass
      - secure: "d973eca4aff857dfd8caad0c771b10a6e498c3b3" # GH_REPO_TOKEN

    android:
      components:
      - tools
      - tools # Running this twice get's the latest build tools (https://github.com/codepath/android_guides/wiki/Setting-up-Travis-CI)
      - platform-tools
      - android-${ANDROID_API}
      - build-tools-${ANDROID_BUILD_TOOLS}
      - extra

    script:
      - "./gradlew clean test build"

    before_deploy:
      - openssl aes-256-cbc -K $encrypted_657e27e4d3ee_key -iv $encrypted_657e27e4d3ee_iv -in keystore.jks.enc -out keystore.jks -d
      - cd app/build/outputs/apk/release
      - jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore ${TRAVIS_BUILD_DIR}/keystore.jks -storepass $storepass -keypass $keypass app-release-unsigned.apk key0
      - jarsigner -verify app-release-unsigned.apk
      - "${ANDROID_HOME}/build-tools/${ANDROID_BUILD_TOOLS}/zipalign -v 4 app-release-unsigned.apk TravisAndroid.apk"
      - cd -
      - scripts/tag.sh

    deploy:
      provider: releases
      on:
        branch: master
        tags: true
      api_key: d973eca4aff857dfd8caad0c771b10a6e498c3b3
      file: "app/build/outputs/apk/release/BeerXP.apk"
      overwrite: true
      skip_cleanup: true